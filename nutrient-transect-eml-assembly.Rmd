---
title: "Creating a Data Package for NES-LTER Nutrient Transect Cruise Data"
author: "Stace Beaulieu and Jaxine Wolfe"
date: "May 9, 2019"
output: html_document
---

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# clear workspace for local development
rm(list = ls())

require(here)


# define source for functions developed for the EDI packaging workflow
source(here("edi-utilities.R"))

base_api_url <- 'https://nes-lter-data.whoi.edu/api'

# install necessary libraries
# install.packages("devtools")
# install_github("EDIorg/EMLassemblyline")

# define R packages to require
libs <- c("tidyverse", "readxl", "lubridate", "devtools", "EMLassemblyline", "EML", "maps", "xml2", "rjson")
# load libraries
lapply(libs, require, character.only = TRUE)

```

## Read in Compiled Cruise Data

This chunk loads in the cruise data compiled from the REST API by nearest_station_generalized.ipynb, a python script run in a Jupyter Notebook which determines alternative sample ID, project ID, nearest station, and station distance (developed by Joe Futrelle). This output was saved as a csv in the working directory which is read by this chunk.
```{r}

if (!file.exists("nut_nearest_stations.csv")) {
  print("Run nearest_station_generalized.ipynb to generate compiled cruise output")
} else {
  # read in existant data file
  all_cruises <- read_csv("nut_nearest_stations.csv")

  # define columns to round
  round_cols <- c("nitrate_nitrite", "ammonium", "phosphate", "silicate", "depth", "station_distance")
  # round nutrient, distance, and depth columns
  all_cruises[, round_cols] <- round(all_cruises[, round_cols], 3)
  # round lat and lon columns
  all_cruises[, c("latitude", "longitude")] <- round(all_cruises[, c("latitude", "longitude")], 4)
  
  # reorder by ascending cruise date
  all_cruises <- all_cruises[with(all_cruises, order(date)),]
  
  # write csv
  write.csv(all_cruises, "nes-lter-nutrient-transect.csv", row.names = FALSE)
}
```

```{r}
cruise_list = c('AR22', 'AR24A', 'AR24B', 'AR24C', 'AR28A', 'AR28B', 'AR31A',
       'AR31B', 'AR31C', 'AR32', 'AR34A', 'AR34B', 'AR38', 'AR39B',
       'EN608', 'EN617', 'EN627', 'EN644', 'EN649', 'EN655', 'EN657')
# FIXME remove cruises before 11/2019

all_cruises <- NA
for(cruise_id in cruise_list) {
  cruise_id <- str_to_lower(cruise_id)
  nut_url <- glue::glue('{base_api_url}/nut/{cruise_id}.csv')
  cruise_nut <- NA
  cruise_nut <- read_csv(nut_url)
  if(!is.na(cruise_nut)) {
    print(nut_url)
    if(is.na(all_cruises)) {
      all_cruises <- cruise_nut
    } else {
      all_cruises <- plyr::rbind.fill(all_cruises, cruise_nut)
    }
  }
}
```

```{r}
all_cruises <- all_cruises[order(all_cruises$date), ]
all_cruises <- all_cruises %>% filter(date < '2019-11-01')
```


## QA: Nutrient Outlier Check

Check if there are severe differences in nutrient values between the replicates across cruise, cast, niskin, and depth. Plot these differences to perform a visual check.

```{r}

# calculate the difference between the replicates across all nutrients
nut_check <- all_cruises %>%
  group_by(cruise, cast, niskin, depth) %>%
  mutate(nitrate_nitrite_diff = abs(nitrate_nitrite - lead(nitrate_nitrite)),
         ammonium_diff = abs(ammonium - lead(ammonium)),
         phosphate_diff = abs(phosphate - lead(phosphate)),
         silicate_diff = abs(silicate - lead(silicate))) 
# isolate the outlier value
# nut_check[which.max(nut_check$nitrate_nitrite_diff),]

# define the nutrient outlier columns to gather on
nut_diff_cols <- c("nitrate_nitrite_diff", "phosphate_diff", "ammonium_diff", "silicate_diff")

# convert to long for ease of plotting
nut_check_long <- nut_check %>%
  select(nitrate_nitrite_diff, ammonium_diff, phosphate_diff, silicate_diff) %>%
  filter(nitrate_nitrite_diff != 0) %>%
  gather(nutrient_diffs, value, nut_diff_cols, factor_key = TRUE)

# plot the differences and look for outliers
ggplot(data = nut_check_long, aes(x = nutrient_diffs, y = value)) +
    geom_boxplot(outlier.size = 0.5) +
    # scale_x_datetime(date_breaks = "6 weeks") +
    ylab(paste0("Concentration (µmol/L)")) +
    theme_classic()

```

## QA: Map Sampling Locations

Call the map_locs function from edi-utility.R to map the sampling locations. Perform a visual check.

```{r}

# Map Check
map_locs(df = all_cruises, xvar = "longitude", yvar = "latitude",
         region = "transect", colorvar = "cruise")

```


## QA: Plot nutrients as a check

Plot the distribution of nutrient values across all cruises using a boxplot. 

```{r}
# define the nutrient columns 
nut_cols <- c("nitrate_nitrite", "phosphate", "ammonium", "silicate")

# convert to long for ease of plotting
cruises_long <- all_cruises %>%
    gather(nutrients, value, nut_cols, factor_key = TRUE)

# loop through nutrient columns
for (i in 1:length(nut_cols)) {
  nut_subset <- cruises_long %>% filter(nutrients == nut_cols[i])
  
  # ggplot where x = cast, y = value and the lineplots are grouped by cruise
  p <- ggplot(data = nut_subset, aes(x = date, y = value, color = cruise)) +
    geom_boxplot(outlier.size = 0.5) +
    # scale_x_datetime(date_breaks = "6 weeks") +
    ylab(paste0(nut_cols[i], " concentration (µmol/L)")) +
    theme_classic()
  print(p)
}

```

## QA: Determine if any nutrient values exceed expectations

According to a global range check: nitrate less than 30 umol/l and ammonium less than 5 umol/l based on [Rees et al. 2006](https://doi.org/10.1016/j.dsr2.2006.05.008), phosphate less than 3 (no great reference but this appears to be upper for Atlantic), silicate less than 60 (Elements of Physical Oceanography chapter on marine silica cycle, for deep Atlantic, this is probably too high).

```{r}

if(any(all_cruises$nitrate_nitrite > 30)) cat("nitrate_nitrite_exceeds") 
if(any(all_cruises$ammonium > 5)) cat("ammonium_exceeds")
if(any(all_cruises$phosphate > 3)) cat("phosphate_exceeds")
if(any(all_cruises$silicate > 60)) cat("silicate_exceeds")

```

## QA: Station Distance Outliers
```{r}
# isolate samples that were taken at a distance greater than 2km from the nearest station
st_dist_outliers <- all_cruises %>% filter(distance_km > 2)

```

## EML Assembly

This chunk outputs the final xml file for EDI through the following steps:

Step 1: Populating EML Assembly Line templates with metadata
Step 2: Calculating the geospatial and temporal coverage 
Step 3: Making the XML file 
Step 4: Inserting a custom NES-LTER parent project node 

```{r}

# define input files
metadata <- "nutrient-transect-info"
edi_filename <- "nes-lter-nutrient-transect"
pkg_id <- "knb-lter-nes.4.1"

# Make EML Templates 
xlsx_to_template(metadata.path = metadata, 
                 edi.filename = edi_filename, 
                 rights = "CC0",
                 other.info = TRUE)

# Data Coverage
# isolate date and geospatial columns for input
date_col <- as.Date(all_cruises$date)
lat_col <- all_cruises$latitude
lon_col <- all_cruises$longitude
# run function to determine geospatial and temporal coverage
coverage <- data_coverage(dates = date_col, lat = lat_col, lon = lon_col)

# Make EML
make_eml(path = getwd(),
         dataset.title = "Dissolved inorganic nutrients from NES-LTER Transect cruises, including 4 macro-nutrients from water column bottle samples, ongoing since 2017",
         data.table = paste0(edi_filename, ".csv"),
         data.table.description = "Dissolved inorganic nutrients from water column bottle samples taken on NES-LTER Transect cruises",
         temporal.coverage = c(coverage$startdate, coverage$enddate),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(coverage$North, coverage$East, coverage$South, coverage$West),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)

# Insert Custom Project Node
project_insert(edi_pkg = pkg_id)
```
