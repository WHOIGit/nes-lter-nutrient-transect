---
title: "nes-lter-nutrients-transect-emlassemblyline"
author: "Stace Beaulieu and Jaxine Wolfe"
date: "May 9, 2019"
output: html_document
---

## R Markdown Setup

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# clear workspace for local development
rm(list = ls())

# assign resused directory to a variable
dir <- "/Users/jaxinewolfe/Documents/WHOI/NESLTER/nes-lter-nutrient-transect/"
# set working directory
setwd(dir)

# define source for functions developed for the EDI packaging workflow
source("edi-utilities.R")

# install necessary libraries
# install.packages("devtools")
# install_github("EDIorg/EMLassemblyline")

# define R packages to require
libs <- c("tidyverse", "readxl", "lubridate", "devtools", "EMLassemblyline", "EML", "maps", "xml2")
# load libraries
lapply(libs, require, character.only = TRUE)

```

## Assemble NES-LTER Cruises 

This chunk makes a data table by concatenating the specified cruises called from API.

```{r}
# List of cruises to acquire from: EN608, EN617, EN627, EN644

# pull from API if compiled cruise data file doesnt exist
if (!file.exists("nes-lter-nutrient-transect.csv")) {

# create list of next cruises to concatenate
cruiselist <- c("en608","en617", "en627", "en644")
# the other cruises will be added to this first cruise in the following for loop
previous_cruises <- read_csv(paste0("https://nes-lter-data.whoi.edu/api/nut/", cruiselist[1], ".csv"))

for (k in 2:length(cruiselist)){
  next_cruise <- read_csv(paste0("https://nes-lter-data.whoi.edu/api/nut/", cruiselist[k], ".csv"))
  # bind the next cruise to the compiled cruise dataset
  all_cruises <- rbind(previous_cruises, next_cruise)
  # if statment to reset the previous cruises until all cruises are read in
    if(k < length(cruiselist)) {
      previous_cruises <- all_cruises
    }
}
  all_cruises$nitrate_nitrite <- round(all_cruises$nitrate_nitrite, 3)
  all_cruises$ammonium <- round(all_cruises$ammonium, 3)
  all_cruises$phosphate <- round(all_cruises$phosphate, 3)
  all_cruises$silicate <- round(all_cruises$silicate, 3)
  # write csv file of concatenated cruises
  # Output the data table to csv file within the same folder as metadata files
  write.csv(all_cruises, 'nes-lter-nutrient-transect.csv', row.names=FALSE)
} else {
  # read in fisheries
  all_cruises <- read_csv("nes-lter-nutrient-transect.csv")
  # round nutrient decimal places
}
  
```

## QA: Comparing Old and New Cruises
```{r}
# read in old cruises and subset new cruises read in from updated API
all_cruises_new <- all_cruises %>% filter(cruise != "EN644")
all_cruises_old <- read_csv("nes-lter-nutrient-transect-old.csv")

# compare between old and new cruises
unique(round(all_cruises_old$nitrate_nitrite, 3) == round(all_cruises_new$nitrate_nitrite, 3))
unique(round(all_cruises_old$ammonium, 3) == round(all_cruises_new$ammonium, 3))
unique(round(all_cruises_old$phosphate, 3) == round(all_cruises_new$phosphate, 3))
unique(round(all_cruises_old$silicate, 3) == round(all_cruises_new$silicate, 3))
unique(round(all_cruises_old$depth, 1) == round(all_cruises_new$depth, 1))
```


## QA: Nutrient Outlier Check
```{r}
# define the nutrient outlier columns
nut_diff_cols <- c("nitrate_nitrite_diff", "phosphate_diff", "ammonium_diff", "silicate_diff")

# calculate the difference between the replicates across all nutrients
nut_check <- all_cruises %>%
  group_by(cruise, cast, niskin, depth) %>%
  mutate(nitrate_nitrite_diff = abs(nitrate_nitrite - lead(nitrate_nitrite)),
         ammonium_diff = abs(ammonium - lead(ammonium)),
         phosphate_diff = abs(phosphate - lead(phosphate)),
         silicate_diff = abs(silicate - lead(silicate))) 

# isolate the outlier value
# nut_check[which.max(nut_check$nitrate_nitrite_diff),]

# convert to long for ease of plotting
nut_check_long <- nut_check %>%
  select(nitrate_nitrite_diff, ammonium_diff, phosphate_diff, silicate_diff) %>%
  filter(nitrate_nitrite_diff != 0) %>%
  gather(nutrient_diffs, value, nut_diff_cols, factor_key = TRUE)

# plot the differences and look for outliers
ggplot(data = nut_check_long, aes(x = nutrient_diffs, y = value)) +
    geom_boxplot(outlier.size = 0.5) +
    # scale_x_datetime(date_breaks = "6 weeks") +
    ylab(paste0("Concentration (µmol/L)")) +
    theme_classic()

```

## QA: Map Sampling Locations

```{r}

# Map Check
map_locs(all_cruises, longitude, latitude, region = "transect")

```


## QA: Plot nutrients as a check

```{r}

nut_cols <- c("nitrate_nitrite", "phosphate", "ammonium", "silicate")

# convert to long for ease of plotting
cruises_long <- all_cruises %>%
    gather(nutrients, value, nut_cols, factor_key = TRUE)

for (i in 1:length(nut_cols)) {
  nut_subset <- cruises_long %>% filter(nutrients == nut_cols[i])
  
  # ggplot where x = cast, y = value and the lineplots are grouped by cruise
  p <- ggplot(data = nut_subset, aes(x = date, y = value, color = cruise)) +
    geom_boxplot(outlier.size = 0.5) +
    # scale_x_datetime(date_breaks = "6 weeks") +
    ylab(paste0(nut_cols[i], " concentration (µmol/L)")) +
    theme_classic()
  print(p)
}

```

## QA: Determine if any nutrients values exceed expectations

```{r}

# In terms of global range check, I checked the following: nitrate less than 30 umol/l and ammonium less than 5 umol/l (based on Rees et al. 2006 https://doi.org/10.1016/j.dsr2.2006.05.008), phosphate less than 3 (I can't find a good reference quickly but this appears to be upper for Atlantic), silicate less than 60 (Elements of Physical Oceanography chapter on marine silica cycle, for deep Atlantic, this is probably too high). AR24B cast 4 has anomalously high ammonium, with samples 241, 242, and 243 higher than the global range check. Anything special about this cast, or these samples in particular?
if(any(all_cruises$nitrate_nitrite > 30)) cat("nitrate_nitrite_exceeds") 
if(any(all_cruises$ammonium > 5)) cat("ammonium_exceeds")
if(any(all_cruises$phosphate > 3)) cat("phosphate_exceeds")
if(any(all_cruises$silicate > 60)) cat("silicate_exceeds")

```

## EML Assembly

This chunk outputs the final xml file for EDI through the following steps:

Step 1: Populating EML Assembly Line templates with metadata
Step 2: Calculating the geospatial and temporal coverage 
Step 3: Making the XML file 
Step 4: Inserting a custom NES-LTER parent project node 

```{r}

# define input files
metadata <- "nutrient-transect-info"
edi_filename <- "nes-lter-nutrient-transect"
pkg_id <- "knb-lter-nes.4.1"

# Make EML Templates 
xlsx_to_template(metadata.path = metadata, 
                 edi.filename = edi_filename, 
                 rights = "CC0")

# Data Coverage
# isolate date and geospatial columns for input
date_col <- as.Date(all_cruises$date)
lat_col <- all_cruises$latitude
lon_col <- all_cruises$longitude
# run function to determine geospatial and temporal coverage
coverage <- data_coverage(dates = date_col, lat = lat_col, lon = lon_col)

# Make EML
make_eml(path = getwd(),
         dataset.title = "Dissolved inorganic nutrients from NES-LTER Transect cruises, including 4 macro-nutrients from water column bottle samples, ongoing since 2017",
         data.table = paste0(edi_filename, ".csv"),
         data.table.description = "Dissolved inorganic nutrients measured from water column bottle samples taken on NES-LTER Transect cruises, ongoing since 2017, including nitrate + nitrite, ammonium, silicate, and phosphate.",
         temporal.coverage = c(coverage$startdate, coverage$enddate),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(coverage$North, coverage$East, coverage$South, coverage$West),
         maintenance.description = "ongoing",
         user.id = "NES",
         affiliation = "LTER",
         package.id = pkg_id)

# Insert Custom Project Node
project_insert(edi_pkg = pkg_id)
```
