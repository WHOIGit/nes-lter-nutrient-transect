---
title: "nes-lter-nutrients-transect-emlassemblyline"
author: "Stace Beaulieu and Jaxine Wolfe"
date: "May 9, 2019"
output: html_document
---

## R Markdown Setup

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# clear workspace for local development
rm(list = ls())

# install libraries for EML assembly
# install.packages("devtools")
# install_github("EDIorg/EMLassemblyline")

# define R packages to require
libs <- c("tidyverse", "readxl", "lubridate", "devtools", "EMLassemblyline", "EML")
# load libraries
lapply(libs, require, character.only = TRUE)

# assign resused directory to a variable
dir <- "/Users/jaxinewolfe/Documents/WHOI/NESLTER/nes-lter-nutrient-transect/"
# set working directory
setwd(dir)

```

## Assemble NES-LTER Cruises 

This chunk makes a data table by concatenating the specified cruises called from API.

```{r}
# List of cruises to acquire from: EN608, EN617, EN627

# pull from API if compiled cruise data file doesnt exist
if (!file.exists("nes-lter-nutrient-transect.csv")) {

# create list of next cruises to concatenate
cruiselist <- c("en608","en617", "en627")
# the other cruises will be added to this first cruise in the following for loop
previous_cruises <- read_csv(paste0("https://nes-lter-data.whoi.edu/api/nut/", cruiselist[1], ".csv"))

for (k in 2:length(cruiselist)){
  next_cruise <- read_csv(paste0("https://nes-lter-data.whoi.edu/api/nut/", cruiselist[k], ".csv"))
  # bind the next cruise to the compiled cruise dataset
  all_cruises <- rbind(previous_cruises, next_cruise)
  # if statment to reset the previous cruises until all cruises are read in
    if(k < length(cruiselist)) {
      previous_cruises <- all_cruises
    }
}
# write csv file of concatenated cruises
# Output the data table to csv file within the same folder as metadata files
write.csv(all_cruises, 'nes-lter-nutrient-transect.csv', row.names=FALSE)

} else {
  # read in fisheries
  all_cruises <- read_csv("nes-lter-nutrient-transect.csv")
}
  
```

## Quality Assurance: Nutrient Check
```{r}

# Mean nutrients
nut_check <- all_cruises %>% 
  group_by(cruise, cast) %>%
  summarise(mean_nitrate_nitrite = mean(nitrate_nitrite),
            mean_ammonium = mean(ammonium),
            mean_phosphate = mean(phosphate),
            mean_silicate = mean(silicate))

```

## Quality Assurance: Map Sampling Locations

```{r}
library(maps)
library(dplyr)

nes <- map_data("state") %>% filter(long > -72 & lat < 42)

# Justin's given coordinates
ggplot() +
  geom_polygon(data = nes, mapping = aes(x = long, y = lat, group = group),
               fill = NA, color = "grey50") +
  geom_point(all_cruises, mapping = aes(x = longitude, y = latitude, color = cruise),
            size = 1) + 
  coord_fixed(1.3) +
  theme_classic()

```


## Quality Assurance: Plot nutrients as a check

```{r}

nut_cols <- c("nitrate_nitrite", "phosphate", "ammonium", "silicate")

# convert to long for ease of plotting
cruises_long <- all_cruises %>%
    gather(nutrients, value, nut_cols, factor_key = TRUE)

for (i in nut_cols) {
  nut_subset <- cruises_long %>% filter(nutrients == nut_cols[i])
# ggplot where x = cast, y = value and the lineplots are grouped by cruise
  p <- ggplot(data = cruises_long, aes(x = cast, y = value, color = cruise)) +
    geom_point() +
    ylab(paste0(nut_cols[i], " concentration (Âµmol/L)")) +
    theme_classic()
  print(p)
}

```

## Determine if any nutrients values exceed expectations

```{r}
# In terms of global range check, I checked the following: nitrate less than 30 umol/l and ammonium less than 5 umol/l (based on Rees et al. 2006 https://doi.org/10.1016/j.dsr2.2006.05.008), phosphate less than 3 (I can't find a good reference quickly but this appears to be upper for Atlantic), silicate less than 60 (Elements of Physical Oceanography chapter on marine silica cycle, for deep Atlantic, this is probably too high). AR24B cast 4 has anomalously high ammonium, with samples 241, 242, and 243 higher than the global range check. Anything special about this cast, or these samples in particular?
if(any(all_cruises$nitrate_nitrite > 30)) cat("nitrate_nitrite_exceeds") 
if(any(all_cruises$ammonium > 5)) cat("ammonium_exceeds")
if(any(all_cruises$phosphate > 3)) cat("phosphate_exceeds")
if(any(all_cruises$silicate > 60)) cat("silicate_exceeds")

```


## Construct XML for Nutrient Data

```{r}

nutrient_csv <- "nes-lter-nutrient-transect.csv"
nutrient_pkg <- "knb-lter-nes.4.1"

# Temporal coverage
# Will need this in make_eml YYYY-MM-DD
column_of_dates <- as.Date(all_cruises$date)
startdate <- min(column_of_dates, na.rm = TRUE)
enddate <- max(column_of_dates, na.rm = TRUE)
# temporal.coverage argument is expecting objects of 'character' class, not 'Date'
startdate_as_character <- as.character(startdate)
enddate_as_character <- as.character(enddate)

# Geographic coverage
# Will need this order in make_eml: North, East, South, West
North <- max(all_cruises$latitude, na.rm = TRUE)
East <- max(all_cruises$longitude, na.rm = TRUE)
South <- min(all_cruises$latitude, na.rm = TRUE)
West <- min(all_cruises$longitude, na.rm = TRUE)

# ensure metadata template txt files are UTF-8 and at specified path
make_eml(path = dir,
         data.path = dir,
         dataset.title = "Dissolved inorganic nutrients from NES-LTER Transect cruises, including 4 macro-nutrients from water column bottle samples, ongoing since 2017",
         data.table = nutrient_csv,
         data.table.description = "Dissolved inorganic nutrients measured from water column bottle samples taken on NES-LTER Transect cruises, ongoing since 2017, including nitrate + nitrite, ammonium, silicate, and phosphate.",
         temporal.coverage = c(startdate_as_character, enddate_as_character),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(North, East, South, West),
         maintenance.description = "ongoing",
         user.id = "NES",
         affiliation = "LTER",
         package.id = nutrient_pkg)

```

## Insert Custom Project Node

Step 1: Read in the xml file and the new xml node
Step 2: Insert the new node or replace the old node with the new node
Step 3: Write the modified xml file 

Instructions for node replacement using the xml2 package can be found [here](https://cran.r-project.org/web/packages/xml2/vignettes/modification.html).

```{r}
# install.packages("xml2")
library(xml2)

# Function inserts project node after the methods node of an xml document
project_insert <- function(x, projectnode) {
  if (is.na(xml_find_first(x, ".//project")) == FALSE) {
    stop("<project> node already exists")
  }
  
  # find methods node
  methodsnode <- xml_find_first(x, ".//methods")
  # add project node after methods and before dataTable
  xml_add_sibling(methodsnode, projectnode, where = "after")
  
  if (eml_validate(x) == FALSE) {
    warning("XML document not valid")
  }
  return(x)
}

# read in project node
project_eml <- read_xml("parent_project.txt", from = "xml")
# read in xml files exported by make_eml
nutrient_eml <- read_xml(paste0(dir, "/", nutrient_pkg, ".xml"), from = "xml")
# all objects should be of class c("xml_document" "xml_node")

# make the neccessary modifications
nutrient_eml_final <- project_insert(nutrient_eml, project_eml)

# write modified xml file
write_xml(nutrient_eml_final, paste0(dir, "/", nutrient_pkg, ".xml"))

```

